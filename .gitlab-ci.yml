variables:
  FW_VERSION_PS: '.scripts\fw-version.ps1'
  CORE_VERSION_PS: '.scripts\core-version.ps1'
  PACKAGE_PS: '.scripts\package.ps1'
  DEFAULT_SLN: 'GoC.WebTemplate.sln'
  xUNIT_PATH: 'packages\xunit.runner.console.2.4.1\tools\net461'
  TEST_FRAME_PATH: 'Components.Framework.Tests\bin\Release'
  
stages:
  - Prepare
  - Build
  - Test
  - Package
  - Deploy

include:
  - local: '/.gitlab/ci/prepare.gitlab-ci.yml'
  - local: '/.gitlab/ci/build.gitlab-ci.yml'
  - local: '/.gitlab/ci/test.gitlab-ci.yml'
  - local: '/.gitlab/ci/package.gitlab-ci.yml'
  - local: '/.gitlab/ci/deploy.gitlab-ci.yml'

.secrets:
  before_script:
    - 'copy $env:SECRETS_PATH\\GoC.WebTemplate.snk .'
  after_script:
    - 'del GoC.WebTemplate.snk'

.cache:
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths: 
      - packages/

Tag:
  stage: .post
  tags:
    - ps
  script:
    - git config --global user.email $env:GIT_AUTHOR_EMAIL
    - git config --global user.name &env:GIT_AUTHOR_NAME
    - sed -i -r 's/(url = .*):(.*)@(.*)/\1:'$env:GIT_AUTHOR_TOKEN'@\3/' .git/config
    - git tag -a v1.0 -m "test tag"
    - git push -o ci.skip origin --tags